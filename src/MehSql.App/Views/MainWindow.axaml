<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:MehSql.App.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:AvaloniaEdit="using:AvaloniaEdit"
        mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
        x:Class="MehSql.App.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        DragDrop.AllowDrop="True"
        Width="1400" Height="900"
        Title="MehSQL - Phase 2">

  <Design.DataContext>
    <vm:MainWindowViewModel />
  </Design.DataContext>

  <Grid RowDefinitions="Auto,*">
    <!-- Menu Bar -->
    <Menu Grid.Row="0" Background="{StaticResource SurfaceBrush}" Foreground="{StaticResource TextBrush}">
      <MenuItem Header="_File" Foreground="{StaticResource TextBrush}">
        <MenuItem Header="_New Database" InputGesture="Ctrl+N" Click="OnNewDatabaseClick"/>
        <MenuItem Header="_Open Database" InputGesture="Ctrl+O" Click="OnOpenDatabaseClick"/>
        <MenuItem Header="Open _SQL File" InputGesture="Ctrl+Shift+O" Click="OnOpenSqlFileClick"/>
        <MenuItem Header="_Recent" x:Name="RecentFilesMenu" IsEnabled="False">
          <MenuItem Header="(none)"/>
        </MenuItem>
        <Separator/>
        <MenuItem Header="E_xit" InputGesture="Alt+F4" Click="OnExitClick"/>
      </MenuItem>
      <MenuItem Header="_Edit" Foreground="{StaticResource TextBrush}">
        <MenuItem Header="_Preferences" InputGesture="Ctrl+," Click="OnPreferencesClick"/>
        <MenuItem Header="_Toggle Theme" InputGesture="Ctrl+T" Click="OnToggleThemeClick"/>
      </MenuItem>
      <MenuItem Header="_View" Foreground="{StaticResource TextBrush}">
        <MenuItem Header="_Refresh" InputGesture="F5" Command="{Binding RunQueryCommand}"/>
      </MenuItem>
      <MenuItem Header="_Help" Foreground="{StaticResource TextBrush}">
        <MenuItem Header="_About" Click="OnAboutClick"/>
      </MenuItem>
    </Menu>

    <!-- Main Content: 3-Pane Layout -->
    <Grid Grid.Row="1" ColumnDefinitions="300,5,*">

      <!-- LEFT PANE: Schema Explorer -->
      <Border Grid.Column="0" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,1,0" Background="{StaticResource SurfaceBrush}">
        <Grid RowDefinitions="Auto,Auto,*">
          <TextBlock Grid.Row="0" Text="Schema Explorer" FontWeight="Bold" Padding="8" Background="{StaticResource SurfaceLightBrush}" Foreground="{StaticResource TextBrush}"/>
          <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="4" Margin="4">
            <Button Content="ðŸ”„ Refresh" Command="{Binding SchemaExplorer.RefreshCommand}" IsEnabled="{Binding !SchemaExplorer.IsLoading}"/>
            <ProgressBar IsVisible="{Binding SchemaExplorer.IsLoading}" IsIndeterminate="True" Width="60" VerticalAlignment="Center"/>
          </StackPanel>
          <TreeView Grid.Row="2" Margin="4" ItemsSource="{Binding SchemaExplorer.RootNodes}">
            <TreeView.ItemTemplate>
              <TreeDataTemplate ItemsSource="{Binding Children}">
                <TextBlock Text="{Binding DisplayName}" Foreground="{StaticResource TextBrush}">
                  <TextBlock.ContextMenu>
                    <ContextMenu IsVisible="{Binding SelectTopRowsCommand, Converter={x:Static ObjectConverters.IsNotNull}}">
                      <MenuItem Header="SELECT TOP 1000 Rows" Command="{Binding SelectTopRowsCommand}" />
                    </ContextMenu>
                  </TextBlock.ContextMenu>
                </TextBlock>
              </TreeDataTemplate>
            </TreeView.ItemTemplate>
          </TreeView>
        </Grid>
      </Border>

      <!-- Splitter -->
      <GridSplitter Grid.Column="1" Background="{StaticResource BorderBrush}" Width="5" HorizontalAlignment="Stretch"/>

      <!-- RIGHT PANE: Split into Top (Editor) and Bottom (Results) -->
      <Grid Grid.Column="2" RowDefinitions="*,5,*">

        <!-- TOP RIGHT: SQL Editor -->
        <Grid Grid.Row="0" RowDefinitions="Auto,*">
          <!-- Toolbar -->
          <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Background="{StaticResource SurfaceLightBrush}">
            <TextBlock Grid.Column="0" Text="SQL Editor" FontWeight="Bold" Padding="8" VerticalAlignment="Center" Foreground="{StaticResource TextBrush}"/>
            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4" Margin="8">
              <Button Content="ðŸ“‚ Open SQL" Click="OnOpenSqlFileClick" Padding="8,4" ToolTip.Tip="Open a .sql file (Ctrl+Shift+O)"/>
              <Button Classes="primary" Content="Run" Command="{Binding RunQueryCommand}" IsEnabled="{Binding !IsExecuting}" Padding="12,4"/>
              <Button Content="Cancel" Command="{Binding CancelQueryCommand}" IsEnabled="{Binding IsExecuting}" Padding="12,4"/>
              <ProgressBar IsVisible="{Binding IsExecuting}" IsIndeterminate="True" Width="60" VerticalAlignment="Center" Margin="8,0,0,0"/>
            </StackPanel>
          </Grid>

          <!-- SQL Editor with Syntax Highlighting -->
          <Border Grid.Row="1" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,1,0,0">
            <AvaloniaEdit:TextEditor x:Name="SqlEditor"
                     FontFamily="Consolas, Monaco, monospace"
                     FontSize="13"
                     Padding="8"
                     Background="{StaticResource SurfaceBrush}"
                     Foreground="{StaticResource TextBrush}"
                     ShowLineNumbers="True"
                     HorizontalScrollBarVisibility="Auto"
                     VerticalScrollBarVisibility="Auto">
              <AvaloniaEdit:TextEditor.KeyBindings>
                <KeyBinding Gesture="F5" Command="{Binding RunQueryCommand}"/>
                <KeyBinding Gesture="Ctrl+Return" Command="{Binding RunQueryCommand}"/>
                <KeyBinding Gesture="Ctrl+Shift+C" Command="{Binding CancelQueryCommand}"/>
              </AvaloniaEdit:TextEditor.KeyBindings>
            </AvaloniaEdit:TextEditor>
          </Border>
        </Grid>

        <!-- Horizontal Splitter -->
        <GridSplitter Grid.Row="1" Background="{StaticResource BorderBrush}" Height="5" HorizontalAlignment="Stretch"/>

        <!-- BOTTOM RIGHT: Query Results -->
        <Grid Grid.Row="2" RowDefinitions="Auto,Auto,*,Auto">
          <!-- Ordering Warning Panel -->
          <Border Grid.Row="0"
                  Background="{StaticResource WarningBrush}"
                  BorderBrush="{StaticResource WarningBrush}"
                  BorderThickness="0,0,0,1"
                  Padding="8"
                  IsVisible="{Binding Results.HasOrderingWarning}">
            <StackPanel Orientation="Horizontal" Spacing="8">
              <TextBlock Text="âš " Foreground="White" FontSize="14" VerticalAlignment="Center"/>
              <TextBlock Text="Query does not have ORDER BY. Paging may be non-deterministic." Foreground="White" FontSize="11" TextWrapping="Wrap"/>
            </StackPanel>
          </Border>

          <!-- Error Panel -->
          <Border Grid.Row="1"
                  Background="{StaticResource ErrorBrush}"
                  BorderBrush="{StaticResource ErrorBrush}"
                  BorderThickness="0,0,0,1"
                  Padding="8"
                  IsVisible="{Binding HasError}">
            <StackPanel>
              <TextBlock Text="Error" FontWeight="Bold" Foreground="White" FontSize="12"/>
              <TextBlock Text="{Binding ErrorMessage}" TextWrapping="Wrap" Foreground="White" FontSize="12" Margin="0,2,0,0"/>
            </StackPanel>
          </Border>

          <!-- Results/Explain Tab Control -->
          <TabControl Grid.Row="2">
            <TabItem Header="Results">
              <Grid RowDefinitions="Auto,*">
                <!-- Results Toolbar -->
                <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Background="{StaticResource SurfaceLightBrush}">
                  <TextBlock Grid.Column="0" Text="Query Results" FontWeight="Bold" Padding="8" VerticalAlignment="Center" Foreground="{StaticResource TextBrush}"/>
                  <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4" Margin="4">
                    <Button Content="Export CSV" Click="OnExportCsvClick" Padding="8,2" FontSize="11" IsEnabled="{Binding !Results.IsExporting}"/>
                    <Button Content="Export JSON" Click="OnExportJsonClick" Padding="8,2" FontSize="11" IsEnabled="{Binding !Results.IsExporting}"/>
                    <TextBlock Text="{Binding Results.ExportStatus}" VerticalAlignment="Center" Margin="8,0" FontSize="11" Foreground="{StaticResource TextTertiaryBrush}"/>
                  </StackPanel>
                </Grid>


                <!-- Results Table -->
                <Grid Grid.Row="1" RowDefinitions="Auto,*">
                  <!-- Sticky header -->
                  <Border Grid.Row="0" Background="{StaticResource SurfaceLightBrush}" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1">
                    <ScrollViewer x:Name="HeaderScrollViewer" HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Disabled">
                      <StackPanel x:Name="ResultsHeaderRow" Orientation="Horizontal"/>
                    </ScrollViewer>
                  </Border>
                  <!-- Virtualized rows -->
                  <ListBox Grid.Row="1"
                           x:Name="ResultsItemsControl"
                           Background="{StaticResource SurfaceBrush}"
                           Foreground="{StaticResource TextBrush}"
                           BorderThickness="0"
                           ScrollViewer.HorizontalScrollBarVisibility="Auto"
                           ScrollViewer.VerticalScrollBarVisibility="Auto">
                    <ListBox.Styles>
                      <Style Selector="ListBoxItem">
                        <Setter Property="Padding" Value="0"/>
                        <Setter Property="Margin" Value="0"/>
                        <Setter Property="MinHeight" Value="0"/>
                      </Style>
                    </ListBox.Styles>
                  </ListBox>
                </Grid>
              </Grid>
            </TabItem>

            <TabItem Header="Explain / Analyze">
              <Grid RowDefinitions="Auto,*">
                <!-- Explain Toolbar -->
                <Grid Grid.Row="0" Background="{StaticResource SurfaceLightBrush}" ColumnDefinitions="Auto,Auto,*">
                  <Button Grid.Column="0" Content="Explain" Command="{Binding Results.ExplainQueryCommand}" IsEnabled="{Binding !Results.IsBusy}" Margin="4" Padding="12,4"/>
                  <Button Grid.Column="1" Classes="primary" Content="Explain Analyze" Command="{Binding Results.ExplainAnalyzeCommand}" IsEnabled="{Binding !Results.IsBusy}" Margin="4" Padding="12,4"/>
                  <TextBlock Grid.Column="2" Text="Shows query execution plan" VerticalAlignment="Center" Margin="8,0" Foreground="{StaticResource TextTertiaryBrush}" FontSize="11"/>
                </Grid>

                <!-- Execution Plan Display -->
                <Border Grid.Row="1" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,1,0,0">
                  <Grid RowDefinitions="Auto,*">
                    <!-- Error Message -->
                    <Border Grid.Row="0" Background="{StaticResource ErrorBrush}" BorderBrush="{StaticResource ErrorBrush}" BorderThickness="0,0,0,1" Padding="8" IsVisible="{Binding Results.ExecutionPlanError, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                      <TextBlock Text="{Binding Results.ExecutionPlanError}" TextWrapping="Wrap" Foreground="White"/>
                    </Border>

                    <!-- Raw Execution Plan Output -->
                    <ScrollViewer Grid.Row="1" IsVisible="{Binding Results.ShowExecutionPlan}">
                      <TextBlock Text="{Binding Results.ExecutionPlan.RawOutput}" FontFamily="Consolas, monospace" FontSize="11" Padding="8" TextWrapping="Wrap" Background="{StaticResource SurfaceBrush}" Foreground="{StaticResource TextBrush}"/>
                    </ScrollViewer>

                    <!-- Empty State -->
                    <TextBlock Grid.Row="1" Text="Click 'Explain' or 'Explain Analyze' to see the query execution plan" VerticalAlignment="Center" HorizontalAlignment="Center" Foreground="{StaticResource TextTertiaryBrush}" IsVisible="{Binding !Results.ShowExecutionPlan}"/>
                  </Grid>
                </Border>
              </Grid>
            </TabItem>
          </TabControl>

          <!-- Performance Panel (Bottom) -->
          <Border Grid.Row="3" Background="{StaticResource SurfaceLightBrush}" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,1,0,0" Padding="8">
            <Grid ColumnDefinitions="*,Auto">
              <!-- Timing Metrics -->
              <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="24">
                <StackPanel>
                  <TextBlock Text="DB Execution" Foreground="{StaticResource TextTertiaryBrush}" FontSize="10"/>
                  <TextBlock Text="{Binding Results.Timings.DbExecutionTime.TotalMilliseconds, StringFormat='{}{0:F2} ms', FallbackValue='--'}" FontWeight="SemiBold" FontSize="12" Foreground="{StaticResource TextBrush}"/>
                </StackPanel>
                <StackPanel>
                  <TextBlock Text="Fetch Time" Foreground="{StaticResource TextTertiaryBrush}" FontSize="10"/>
                  <TextBlock Text="{Binding Results.Timings.FetchTime.TotalMilliseconds, StringFormat='{}{0:F2} ms', FallbackValue='--'}" FontWeight="SemiBold" FontSize="12" Foreground="{StaticResource TextBrush}"/>
                </StackPanel>
                <StackPanel>
                  <TextBlock Text="UI Bind" Foreground="{StaticResource TextTertiaryBrush}" FontSize="10"/>
                  <TextBlock Text="{Binding Results.Timings.UiBindTime.TotalMilliseconds, StringFormat='{}{0:F2} ms', FallbackValue='--'}" FontWeight="SemiBold" FontSize="12" Foreground="{StaticResource TextBrush}"/>
                </StackPanel>
                <StackPanel>
                  <TextBlock Text="Total" Foreground="{StaticResource TextTertiaryBrush}" FontSize="10"/>
                  <TextBlock FontWeight="SemiBold" FontSize="12" Foreground="{StaticResource TextBrush}">
                    <TextBlock.Text>
                      <MultiBinding StringFormat="{}{0:F2} ms">
                        <Binding Path="Results.Timings.TotalTime.TotalMilliseconds" FallbackValue="--"/>
                      </MultiBinding>
                    </TextBlock.Text>
                  </TextBlock>
                </StackPanel>
                <StackPanel>
                  <TextBlock Text="Rows" Foreground="{StaticResource TextTertiaryBrush}" FontSize="10"/>
                  <TextBlock Text="{Binding Results.RowCount}" FontWeight="SemiBold" FontSize="12" Foreground="{StaticResource TextBrush}"/>
                </StackPanel>
              </StackPanel>

              <!-- Planning Time (when available) -->
              <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="12" IsVisible="{Binding Results.ExecutionPlan.PlanningTime, Converter={x:Static ObjectConverters.IsNotNull}}">
                <StackPanel>
                  <TextBlock Text="Planning" Foreground="{StaticResource TextTertiaryBrush}" FontSize="10"/>
                  <TextBlock Text="{Binding Results.ExecutionPlan.PlanningTime, StringFormat='{}{0:F2} ms'}" FontWeight="SemiBold" FontSize="12" Foreground="{StaticResource PrimaryBrush}"/>
                </StackPanel>
                <StackPanel IsVisible="{Binding Results.ExecutionPlan.ExecutionTime, Converter={x:Static ObjectConverters.IsNotNull}}">
                  <TextBlock Text="Execution" Foreground="{StaticResource TextTertiaryBrush}" FontSize="10"/>
                  <TextBlock Text="{Binding Results.ExecutionPlan.ExecutionTime, StringFormat='{}{0:F2} ms'}" FontWeight="SemiBold" FontSize="12" Foreground="{StaticResource PrimaryBrush}"/>
                </StackPanel>
              </StackPanel>
            </Grid>
          </Border>
        </Grid>
      </Grid>
    </Grid>
  </Grid>
</Window>
